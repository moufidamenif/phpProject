define(["ytos.domlib","ytos.product","common.guestWishListManager","ui.layer"],(function(t,e,s){"use strict";yTos.utils.namespace("yTos.helpers.Product.ToggleProductInWishlist");const i="variantInWishlist",o=function(t){if($Y.isLogged())r.wishlist=Promise.resolve(t);else{const e=t.map((function(t){return t.colorPartNumber})),s=t.map((function(t){return t.partNumber}));r.wishlist=Promise.resolve(e.concat(s).filter((function(t,e,s){return s.indexOf(t)===e})))}},r=yTos.helpers.Product.ToggleProductInWishlist=yTos.helpers.base.extend({initialize:function(){const t=this.model=yTos.models.ProductsCollection({scope:this.scope});this.unsubFn=$Y.subscribeOnce("yTos::HelpersFinishedLoading",this.onColorSizeChange.bind(this)),t.watch("selectedColor",this.onColorSizeChange,this),t.watch("selectedSize",this.onColorSizeChange,this)},localMessages:{"yTos::Product::AddProductToWishlistError":"openLayer"},openLayer:function(t){this.notify("yTos::OpenLayer",t)},destroy:function(){this.unsubFn(),this._super()},events:{click:"toggle"},updateDom:function(t){r.wishlist.then(function(e){const s=this.doesWishlistContainAtLeastOneOfThesePartNumbers(e,t);this.$el.toggleClass(i,s),this.$el.attr("aria-pressed",s)}.bind(this))},doesWishlistContainAtLeastOneOfThesePartNumbers:function(t,e){return e.some((function(e){return t.indexOf(e)>=0}))},isInWishlist:function(){return this.$el.hasClass(i)},onColorSizeChange:function(){this.getPartNumbersToCheck(this.model.get("selectedColor"),this.model.get("selectedSize")).then(this.updateDom.bind(this))},getPartNumbersToCheck:function(t,e){return t&&e?this.model.getProduct(t,e).then((function(t){return"OneSize"===t.productSize.identifier?[t.colorPartNumber,t.skuPartNumber]:[t.skuPartNumber]})):t?this.model.getColorPartNumber(t).then(function(t){return[t].concat(this.options.colors[t])}.bind(this)):Promise.resolve([this.options.selectedColorPartNumber].concat(this.options.colors[this.options.selectedColorPartNumber]))},toggle:function(){this.getPartNumberToSend(this.model.get("selectedColor"),this.model.get("selectedSize")).then(function(t){this.updateWishlist(t).then(function(e){o(e),this.updateDom([t])}.bind(this))}.bind(this))},getPartNumberToSend:function(t,e){return t&&e?this.model.getSkuPartNumber(t,e):t?this.model.getColorPartNumber(t):Promise.resolve(this.options.selectedColorPartNumber)},updateWishlist:function(t){return $Y.isLogged()?this.isInWishlist()?this.removeProductFromWishlist(t):this.addProductInWishlist(t):$Y.localStorage.isAvailable()?this.toggleProductInGuestWishlist(t):Promise.resolve([])},toggleProductInGuestWishlist:function(t){return this.model.getColorPartNumber(this.model.get("selectedColor")).then(function(e){e||(e=this.options.selectedColorPartNumber);try{this.notifyTrackingEvent(e,t);const i=s.toggle(e,t,this.model.get("siteCode"),this.options.guestWishListMaxItems);return this.notify("yTos::Product::WishlistUpdatedByToggle",{colorPartNumber:e,partNumber:t}),i}catch(e){return this.notify("yTos::Product::AddProductToWishlistError",{content:this.options.wishListFullErrorLabel,partNumber:t,statusCode:403},{scope:this.scope}),s.retrieveGuestWishListFromLocalStorage()}}.bind(this))},notifyTrackingEvent:function(t,e){const i=this.model.get("selectedColor"),o=this.model.get("selectedSize"),r=s.isInGuestWishlist(t,e,this.model.get("siteCode"))?"RemovedFrom":"AddedTo",n={colorPartNumber:t,partNumber:e,selectedColor:i,selectedSize:o};this.notify(`yTos::Tracking::Item${r}GuestWishlist`,n)},addProductInWishlist:function(e){return this.disableButton(),this.postHTML({Plugin:"Item",Action:"AddProductToWishListForToggle"},{data:{partNumber:e,wishlistId:r.wishlistId}}).then(function(){return this.enableButton(),this.notify("yTos::Product::ProductAddedToWishlist",{skuPartNumber:e}),this.notify("yTos::Tracking::ItemAddedToWishlist",{size:this.model.get("selectedSize"),color:this.model.get("selectedColor"),partNumber:e}),r.wishlist.then((function(t){return t.push(e),t}))}.bind(this)).catch(function(s){this.enableButton();const i=t($Y.trim(s.responseText)),o=i.data("ytosErrorkey");return this.notify("yTos::Product::AddProductToWishlistError",{content:i,statusCode:s.status,errorKey:o},{scope:this.scope}),this.notify("yTos::Tracking::ItemAddedToWishlistError",{size:this.model.get("selectedSize"),color:this.model.get("selectedColor"),partNumber:e}),r.wishlist}.bind(this))},removeProductFromWishlist:function(e){return this.disableButton(),this.postHTML({Plugin:"Item",Action:"RemoveProductFromWishListForToggle"},{data:{partNumber:e,wishlistId:r.wishlistId}}).then(function(){return this.enableButton(),this.notify("yTos::Product::ProductRemovedFromWishlist",{skuPartNumber:e}),r.wishlist.then((function(t){return t.filter((function(t){return t!==e}))}))}.bind(this)).catch(function(e){this.enableButton();const s=t($Y.trim(e.responseText)),i=s.data("ytosErrorkey");return this.notify("yTos::Product::RemoveProductFromWishlistError",{content:s,statusCode:e.status,errorKey:i},{scope:this.scope}),r.wishlist}.bind(this))},disableButton:function(){this.$el.attr({disabled:"disabled","aria-disabled":"true"})},enableButton:function(){this.$el.attr("aria-disabled","false"),this.$el.prop("disabled",!1)}});if($Y.isLogged())r.wishlist=yTos.ajax("/yTos/Plugins/itemPlugin/GetWishListForToggle").then((function(t){return r.wishlistId=t.WishListId,Promise.resolve(t.PartNumbers)}));else if($Y.localStorage.isAvailable()){const t=s.retrieveGuestWishListFromLocalStorage();o(t)}else r.wishlist=Promise.resolve([]);return r}));