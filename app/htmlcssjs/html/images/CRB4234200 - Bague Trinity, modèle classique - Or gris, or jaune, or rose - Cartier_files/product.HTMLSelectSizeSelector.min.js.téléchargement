define(["ytos.domlib","ytos.product","ui.selectAsList","ytos.share"],function(a,b,c){"use strict";return yTos.utils.namespace("yTos.helpers.Product.HTMLSelectSizeSelector"),yTos.helpers.Product.HTMLSelectSizeSelector=yTos.helpers.base.extend({initialize:function(){var a=this.model=yTos.models.ProductsCollection({scope:this.scope}),b=this.share=yTos.models.ShareCollection({scope:this.scope});a.watch("selectedColor",this.checkSelectedCombinationIsAvailable,this),a.watch("selectedProduct",function(){this.updatesDropdown(a.get("selectedSize"))},this),this.trySetDefaults(),this.storeCurrentSizes(),this.shouldInitShareUrl()&&this.updatesDropdown(b.get("size"))},shouldInitShareUrl:function(){return this.options.ShouldEnableShareUrl&&this.options.ShouldInitShareUrl},events:{"select change":"selectSize"},globalMessages:{"yTos::Product::PrivateSalesAllowed":"refresh"},localMessages:{"yTos::Product::UpdateExchangeableSizes":"setExchangeableSizesBySkuPartNumbers","yTos::Product::HTMLSelectSizeSelectorUpdated":"storeCurrentSizes"},requiredHelpers:{SelectAsList:c},trySetDefaults:function(){var a=this.shouldInitShareUrl()?this.share.get("size"):void 0,b=a||this.$("select option:selected").val();this.initShareSize(a,b),b&&(this.model.extendDefaults({selectedSize:b,selectedProduct:this.model.getProduct(this.model.get("selectedColor"),b)}),this.model.isProductAvailable(this.model.get("selectedColor"),b).then(function(a){this.model.set("isSelectedProductAvailable",a)}.bind(this)))},initShareSize:function(a,b){a?this.model.set("selectedSize",a):this.options.ShouldEnableShareUrl&&this.share.save("size",b||this.$("select").val())},isDOMUpdatedManually:function(){return 0===this.$el.closest('[data-ytos-ctrl="product.blockUpdater"]').length},refreshAfterInitialization:function(){if(this.isDOMUpdatedManually()){var a=this.options.PartNumber||this.model.get("landingColorPartNumber");this.refresh(a)}},refresh:function(a){a||(a=this.options.PartNumber||this.model.get("landingColorPartNumber"));var b=$Y.pick(["JavaScriptHelperScope","ShouldRenderAvailabilityInfoOnMouseOver","ShouldRenderWhenSingleOption","ShouldDisplayAlternativeSize","ShouldDisplayCentralSizeLabel","ShouldRenderAvailabilityInfo","ShouldRenderOnlyBuyableSizes","ShouldRemoveSelectSizeOption","ShouldSetDisabledAttribute","ShouldSelectTheFirstBuyableSize","AvailabilityType","ShouldEnableShareUrl","ShouldInitShareUrl"],this.options);this.getHTML({Plugin:"Item",Action:"RenderHTMLSelectSizeSelectorAsync"},{data:$Y.prepareData({partNumber:a,siteCode:this.options.SiteCode,options:b}),success:function(a){if(this.options.ShouldEnableShareUrl){var b=this.share.get("size");this.updatesDropdown(b),this.initShareSize(b)}this.notify("yTos::Product::HTMLSelectSizeSelectorUpdated",{$el:a},{scope:this.scope})}.bind(this),autoUpdate:!0,stripMe:!0})},checkSelectedCombinationIsAvailable:function(a){this.model.isProductAvailable(a,this.model.get("selectedSize")).then(this.updateModelState.bind(this))},updateModelState:function(a){this.model.set("isSelectedProductAvailable",a),this.model.set("selectedProduct",this.model.getSelectedProduct())},selectSize:function(b){var c=a(b.currentTarget),d=c.val();this.model.set("selectedSize",d),this.options.ShouldEnableShareUrl&&this.share.save("size",d);var e=c.children('option[value="'+d+'"]');this.notify("yTos::Product::SelectedSizeChanged",{size:e.yTos("sizeModel")},{scope:this.scope}),this.notify("yTos::Tracking::SelectedSizeChanged",{size:e.yTos("sizeModel")},{scope:this.scope})},setExchangeableSizesBySkuPartNumbers:function(a){if(this.defaultSizesCache&&a&&0!==a.skuPartNumbersToInclude.length){var b=this.getSizesIdentifierBySkuPartNumbers(a.skuPartNumbersToInclude);Promise.all(b).then(function(a){var b=this.$("select");this.$("option").remove(),this.defaultSizesCache.each(function(c,d){return""===d.value?void b.append(d):void(a.indexOf(d.value)!==-1&&(b.append(d),this.updateSelectedOption()))}.bind(this))}.bind(this))}},getSizesIdentifierBySkuPartNumbers:function(a){return a.map(function(a,b){return this.model.getProductBySkuPartNumber(a).then(function(a){if(a.productSize&&a.productSize.identifier)return a.productSize.identifier})}.bind(this))},storeCurrentSizes:function(){this.defaultSizesCache=this.$("option")},updatesDropdown:function(a){this.updateSelectedOption(a),this.updateOptions(),this.storeCurrentSizes()},updateSelectedOption:function(a){this.removeSelectedCssClass();var b=this.$("select").get(0);if(a){var c=this.$('option[value="'+a+'"]').addClass("is-selected");b.selectedIndex=c.get(0)?c.get(0).index:0}else b.selectedIndex=0},updateOptions:function(){this.removeDisabledCssClass();var a=this.model.get("selectedColor");a&&this.$("option").each(this.updateOption.bind(this,a))},updateOption:function(b,c,d){var e=a(d),f=e.val();this.model.getProduct(b,f).then(this.updateOptionInternal.bind(this,e))},updateOptionInternal:function(a,b){return null==b?(this.options.ShouldRenderAvailabilityInfo&&this.resetOptionText(a),void this.setUnavailableCssClasses(a)):(a.toggleClass("is-disabled",this.shouldBeDisabled(b)),void(this.options.ShouldRenderAvailabilityInfo&&this.updateOptionWithAvailabilityInfo(a,b)))},shouldBeDisabled:function(a){return null==a||(a.soldOut||!a.buyable)},updateOptionWithAvailabilityInfo:function(a,b){var c=[{cssClass:"is-soldOut",state:b.soldOut,label:this.options.SoldOutLabel},{cssClass:"is-lastItem",state:b.onlyOneLeft,label:this.options.LastItemLabel},{cssClass:"is-limitedAvailability",state:b.limitedAvailability,label:this.options.LimitedAvailabilityLabel},{cssClass:"is-preorder",state:b.preorder,label:this.options.PreorderLabel}],d=c.reduce(function(c,d){return a.toggleClass(d.cssClass,d.state),d.state&&this.updateOptionText(a,b.productSize,d.label),c||d.state}.bind(this),!1);d||this.updateOptionText(a,b.productSize)},updateOptionText:function(a,b,c){var d=this.options.ShouldDisplayCentralSizeLabel&&b.centralSizeLabel?b.centralSizeLabel:b.schema.labels.join(this.options.MultiSizeSeparator),e="undefined"==typeof c?d:$Y.stringFormat("{0}{1}{2}",d,this.options.AvailabilitySeparator,c);a.text(e)},resetOptionText:function(a){var b,c=$Y.trim(a.text());if(this.options.MultiSizeSeparator!==this.options.AvailabilitySeparator)b=c.split(this.options.AvailabilitySeparator)[0];else{var d=c.lastIndexOf(this.options.AvailabilitySeparator),e=c.indexOf(this.options.AvailabilitySeparator);if(d===e){var f=[this.options.SoldOutLabel,this.options.LastItemLabel,this.options.LimitedAvailabilityLabel].some(function(a){return c.indexOf(a)>=0});b=c,f&&(b=c.substr(0,d))}else b=c.substr(0,d)}a.text(b)},removeDisabledCssClass:function(){this.$("option").removeClass("is-disabled")},removeSelectedCssClass:function(){this.$("option").removeClass("is-selected")},setUnavailableCssClasses:function(a){a.addClass("is-disabled").removeClass("is-soldOut is-lastItem is-limitedAvailability is-preorder")}}),yTos.helpers.Product.HTMLSelectSizeSelector});