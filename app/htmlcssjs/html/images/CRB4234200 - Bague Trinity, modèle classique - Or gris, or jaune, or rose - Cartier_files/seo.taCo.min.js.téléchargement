define(["ytos.domlib"],(function(t){"use strict";return yTos.utils.namespace("yTos.tracking.TagCommander"),yTos.tracking.TagCommander=yTos.helpers.base.extend({loadedTagCommanderScripts:!1,formatPrice:function(t,r,e,o){var a=t;r=isNaN(r=Math.abs(r))?2:r,e=void 0===e?",":e,o=void 0===o?".":o;var i=a<0?"-":"",c=parseInt(a=Math.abs(+a||0).toFixed(r),10)+"",d=(d=c.length)>3?d%3:0;return i+(d?c.substr(0,d)+o:"")+c.substr(d).replace(/(\d{3})(?=\d)/g,"$1"+o)+(r?e+Math.abs(a-c).toFixed(r).slice(2):"")},initialize:function(){this.options.enableEventsTracking&&yTos.tracking.registerDriver("TC",this),yTos.configuration.dataLayer&&this.extendDataLayer(),$Y.watch({"yTos::Search::ProductsReady":this.updateSrItems.bind(this)})},globalMessages:{"yTos::UserDataLayerInitialized":"extendDataLayer","yTos::Search::filterAdded":"updateSearchFiltersValues","yTos::Item::QuickBuyLayerHtmlReady":"setQuickBuyOpened","yTos::ItemsListUpdated":"updateItemsList","yTos::Search::ProductsReady":"onSearchProductsReady","yTos::Item::RecentlyViewedHTMLReady":"updateItemsList","yTos::Item::RenderRelatedItemsLoaded":"updateItemsList","yTos::Item::RenderRelatedItemsUpdated":"updateItemsList","yTos::Checkout::PickupShippingAddressFormSuccess":"setPickup","yTos::Checkout::UpsShippingAddressFormSuccess":"resetPickup","yTos::Checkout::ShippingAddressFormSuccess":"resetPickup","yTos::Checkout::SetShippingAddressByIdSuccess":"resetPickup","yTos::Tracking::PaymentMethodChanged":"updatePaymentMethod"},updatePaymentMethod:function(t){this.extendTcVars({cart_PaymentType:t.value})},setPickup:function(){this.extendTcVars({cart_ispickupinstoreselected:!0})},resetPickup:function(){this.extendTcVars({cart_ispickupinstoreselected:!1})},setQuickBuyOpened:function(){this.extendTcVars({env_template:"item",nav_section:"cts",nav_pagetype:"item"})},updateSearchFiltersValues:function(t){const r={};switch(t.key){case"color":r.sr_color=t.value;break;case"size":r.sr_size=t.value}this.extendTcVars(r),this.extendDataLayerWithSrProps(t.key),this.loadTagCommanderScripts()},updateSrItems:function(){window.tc_vars.sr_items={};var r={},e=[];t("[data-ytos-item-code10], [data-ytos-item]").each(function(r,o){var a=t(o),i=a.data("ytosItemCode10")||a.data("ytosItem"),c=a.data("ytosTrackProductData")||{},d=this.formatPrice(c.product_price,2,".",","),n=this.formatPrice(c.product_discountedPrice,2,".",","),s=this.formatPrice(c.product_price_tf,2,".",","),_=this.formatPrice(c.product_discountedPrice_tf,2,".",","),u=a.find('[itemprop="title"]'),p=u.length>0?u.get(0).innerText:"",m=a.find('[data-ytos-ctrl="item.modelName"]'),l=m.length>0?m.get(0).innerText:"",g=u.length>0?p:l;g=$Y.trim(g),e.push({sr_item_cod8:i.toString().substr(0,8),sr_item_cod10:i,sr_item_name:g,sr_item_unitprice_ati:d,sr_item_unitprice_tf:s,sr_item_discount_ati:n,sr_item_discount_tf:_,sr_item_quantity:"",sr_item_macro_category:c.product_macro_category,sr_item_macro_category_id:c.product_macro_category_id,sr_item_micro_category:c.product_micro_category,sr_item_micro_category_id:c.product_micro_category_id,sr_item_brand:c.product_brand,sr_item_color:c.product_color,sr_item_color_id:c.product_color_id,sr_item_position:c.product_position,sr_item_list:"searchresult",sr_item_is_in_stock:!c.hasOwnProperty("product_is_in_stock")||c.product_is_in_stock,product_variant_id:c.product_variant_id,product_id:c.product_id,product_legacy_macro_id:c.product_legacy_macro_id,product_legacy_micro_id:c.product_legacy_micro_id})}.bind(this)),r.sr_items=e,this.extendTcVars(r)},tryGetNewestItemsList:function(t,r){return Object.keys(t).reduce((function(e,o){const a=r&&r[o]?r[o].reduce((function(t,r){for(let e=0;e<t.length;e++)if(t[e].item_cod10===r.item_cod10)return t.splice(e,1),t;return t}),t[o]):t[o];return a.length&&e.push(a),e}),[])},onSearchProductsReady:function(){this.updateItemsList("TcVarsItemsListUpdated")},updateItemsList:function(t){t="string"==typeof t?t:"TcVarsItemsListUpdated";const r=$Y.safeGet(window,"tc_vars.itemsList");window.tc_vars.itemsList={};const e=this._prepareItemsList();this.extendTcVars({itemsList:e}),$Y.notify($Y.stringFormat("yTos::TagCommander::{0}",t));const o=this.tryGetNewestItemsList(e,r);if(0!==o.length&&"function"==typeof window.tc_events_19)try{return window.tc_events_19(this,t,{newestItemsList:o})}catch(r){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}",t,r.message),"error")}},_prepareItemsList:function(){var r={};return t("[data-ytos-track-product-data]").each(function(e,o){var a=t(o).data("ytosTrackProductData")||{},i=a.product_cod10||"",c=this.formatPrice(a.product_price,2,".",","),d=this.formatPrice(a.product_discountedPrice,2,".",","),n=this.formatPrice(a.product_price_tf,2,".",","),s=this.formatPrice(a.product_discountedPrice_tf,2,".",","),_=a.list?a.list:"searchresult";r[_]||(r[_]=[]),r[_].push({item_cod8:i.toString().substr(0,8),item_cod10:i,item_name:a.product_title,item_unitprice_ati:c,item_unitprice_tf:n,item_discount_ati:d,item_discount_tf:s,item_quantity:"",item_macro_category:a.product_macro_category,item_macro_category_id:a.product_macro_category_id,item_micro_category:a.product_micro_category,item_micro_category_id:a.product_micro_category_id,item_brand:a.product_brand,item_color:a.product_color,item_color_id:a.product_color_id,item_position:a.product_position,item_list:a.list,item_inpressionAdded:!1,item_is_in_stock:!a.hasOwnProperty("product_is_in_stock")||a.product_is_in_stock,product_variant_id:a.product_variant_id,product_id:a.product_id,product_legacy_macro_id:a.product_legacy_macro_id,product_legacy_micro_id:a.product_legacy_micro_id,is_rsi_product:a.is_rsi_product,rsi_product_tracking_url:a.rsi_product_tracking_url,product_eng_title:a.product_eng_title,product_eng_casematerial:a.product_eng_casematerial,product_eng_category:a.product_eng_category,product_eng_collection:a.product_eng_collection,product_eng_color:a.product_eng_color,product_eng_jewelmaterial:a.product_eng_jewelmaterial,product_eng_leathermaterial:a.product_eng_leathermaterial,product_eng_micro:a.product_eng_micro,product_eng_season_of_sale:a.product_eng_season_of_sale,product_eng_strapmaterial:a.product_eng_strapmaterial,product_eng_subcollection:a.product_eng_subcollection,product_engravable:a.product_engravable,product_embossable:a.product_embossable,product_adjustable:a.product_adjustable,product_collection:a.product_collection,product_subcollection:a.product_subcollection,product_mfPartNumber:a.product_mfPartNumber,product_defaultMfPartNumber:a.product_defaultMfPartNumber,product_casematerial:a.product_casematerial,product_jewelmaterial:a.product_jewelmaterial,product_leathermaterial:a.product_leathermaterial,product_strapmaterial:a.product_strapmaterial,product_sellable:a.product_sellable})}.bind(this)),r},extendDataLayerWithSrProps:function(t){const r={};yTos.search&&yTos.search.department&&void 0!==t&&(r.nav_subsection=t,r.nav_page=t),this.updateSrItems(),this.updateItemsList("TcVarsItemsListUpdatedFilterAdded"),this.trackPromotionsImpressions(),this.extendTcVars(r)},extendDataLayer:function(){if(this.extendDataLayerWithSrProps(),yTos.configuration.dataLayer.nav_dept=(yTos.navigation.itemData||yTos.navigation).Gender||"X",""!==yTos.navigation.LangId&&(yTos.configuration.dataLayer.nav_languageId=yTos.navigation.LangId),""!==yTos.navigation.Language&&(yTos.configuration.dataLayer.nav_languageCode=yTos.navigation.Language),this.extendTcVars(yTos.configuration.dataLayer),"function"==typeof yTos.configuration.dataLayerFilter)try{yTos.configuration.dataLayerFilter()}catch(t){yTos.debug.log("Error while processing yTos.configuration.dataLayerFilter","error")}this.loadTagCommanderScripts()},extendTcVars:function(r){for(var e in t.extend(!0,window.tc_vars,r),window.tc_vars){if(window.tc_vars.hasOwnProperty(e))null==window.tc_vars[e]&&(window.tc_vars[e]="")}window.tc_vars&&""===window.tc_vars.nav_pagetype&&(window.tc_vars.nav_pagetype=this._getPageString()),this._setRsiStatus()},loadTagCommanderScripts:function(){this.loadedTagCommanderScripts||(this.loadedTagCommanderScripts=!0,this.options.fileName.forEach(function(t){t=t+"?t="+tc_vars.env_version,require([this.options.cdnBasePath+t],function(){this.notify("yTos::TagCommanderCalled")}.bind(this))}.bind(this)))},userAction:function(){return!1},_getPageString:function(){var t=yTos.navigation.Action,r=yTos.navigation.Controller;return"index"!==t?r+"."+t:r},_setRsiStatus:function(){window.tc_vars&&("search"===yTos.navigation.Controller?window.tc_vars.rsiUsed=yTos.search.rsiUsed:"item"===yTos.navigation.Controller&&yTos&&yTos.configuration&&yTos.configuration.dataLayer&&yTos.configuration.dataLayer.product_variant_id&&this._setRsiUsedFromLocalStorage(yTos.configuration.dataLayer.product_variant_id))},trackEvent:function(t,r){var e=t.length>0?t[0]:t;if(void 0!==e&&void 0!==e.driver&&"TC"!==e.driver||"function"!=typeof window.tc_events_19)return!1;var o={category:(r?e.category:window.tc_vars.nav_GAsection+(e.suffix||""))||"-",event:e.event,label:e.label};(t.legacyId||window.tc_vars.product_cod8||window.tc_vars.product_cod10)&&(o.legacyId=t.legacyId||window.tc_vars.product_cod8||window.tc_vars.product_cod10),(t.mfPartNumber||window.tc_vars.product_mfPartNumber)&&(o.mfPartNumber=t.mfPartNumber||window.tc_vars.product_mfPartNumber),(t.defaultMfPartNumber||window.tc_vars.product_defaultMfPartNumber)&&(o.defaultMfPartNumber=t.defaultMfPartNumber||window.tc_vars.product_defaultMfPartNumber),t.dataSt&&(o.dataSt=t.dataSt);try{return window.tc_events_19(this,"univ",o)}catch(t){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}","univ",t.message),"error")}},trackProductData:function(t,r){var e=t.length>0?t[0]:t;if(this._addRsiItemToLocalStorage(e),"function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,r||"enh_prod",{pid:e.product_cod10,name:e.product_title,brand:e.product_brand,category:e.product_category,variant:e.product_color,price:e.product_price,price_tf:e.product_price_tf,discountedPrice:e.product_discountedPrice,discountedPrice_tf:e.product_discountedPrice_tf,quantity:e.product_quantity||1,coupon:e.product_coupon||"",position:e.product_position,list:e.list,product_variant_id:e.product_variant_id,product_id:e.product_id,legacy_micro_id:e.product_legacy_micro_id,legacy_macro_id:e.product_legacy_macro_id,prdid:e.product_cod8,prdname:e.product_eng_title,product_eng_casematerial:e.product_eng_casematerial,product_eng_category:e.product_eng_category,product_eng_collection:e.product_eng_collection,product_eng_color:e.product_eng_color,product_eng_jewelmaterial:e.product_eng_jewelmaterial,product_eng_leathermaterial:e.product_eng_leathermaterial,product_eng_micro:e.product_eng_micro,product_eng_season_of_sale:e.product_eng_season_of_sale,product_eng_strapmaterial:e.product_eng_strapmaterial,product_eng_subcollection:e.product_eng_subcollection,productLine:e.product_line,productCollection:e.product_collection,productSubcollection:e.product_subcollection,productEngravable:e.product_engravable,productEmbossable:e.product_embossable,productAdjustable:e.product_adjustable,product_mfPartNumber:e.product_mfPartNumber,product_defaultMfPartNumber:e.product_defaultMfPartNumber,prdavailability:e.product_is_in_stock,csematerial:e.product_casematerial,prdjewelrymaterial:e.product_jewelmaterial,prdstrapmaterial:e.product_strapmaterial,prdleathermaterial:e.product_leathermaterial,dataSt:e.dataSt})}catch(t){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}",r||"enh_prod",t.message),"error")}},_addRsiItemToLocalStorage:function(t){var r=$Y.storage.get("yTosVisitedRsiItems")||{};r[t.product_id]=t.is_rsi_product,$Y.storage.set("yTosVisitedRsiItems",r),this.notify("yTos::Seo::VisitedRsiItemsStorageSet")},_setRsiUsedFromLocalStorage:function(t){var r=$Y.storage.get("yTosVisitedRsiItems")||{};r.hasOwnProperty(t)&&(window.tc_vars.rsiUsed=r[t],$Y.storage.del("yTosVisitedRsiItems",t))},trackChangeColor:function(t){return this._trackItemAction("colorChanged",t)},trackAddItem:function(t){return this._trackItemAction("enh_addcart",t)},trackRemoveItem:function(t){return this._trackItemAction("enh_removecart",t)},_trackItemAction:function(t,r){var e=r.length>0?r[0]:r;if("function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,t,{pid:e.product_cod10,name:e.product_title,category:e.product_category,brand:e.product_brand,variant:e.product_color||"",price:e.product_price,discount_price:e.product_discount_price,price_ati:e.product_price_ati,discount_price_ati:e.product_discount_price_ati,quantity:e.product_quantity||1,product_variant_id:e.product_variant_id,product_id:e.product_id,legacy_micro_id:e.product_legacy_micro_id,legacy_macro_id:e.product_legacy_macro_id,prdid:e.product_cod8,prdname:e.product_eng_title,product_eng_casematerial:e.product_eng_casematerial,product_eng_category:e.product_eng_category,product_eng_collection:e.product_eng_collection,product_eng_color:e.product_eng_color,product_eng_jewelmaterial:e.product_eng_jewelmaterial,product_eng_leathermaterial:e.product_eng_leathermaterial,product_eng_micro:e.product_eng_micro,product_eng_season_of_sale:e.product_eng_season_of_sale,product_eng_strapmaterial:e.product_eng_strapmaterial,product_eng_subcollection:e.product_eng_subcollection,productLine:e.product_line,productCollection:e.product_collection,productSubcollection:e.product_subcollection,productEngravable:e.product_engravable,productEmbossable:e.product_embossable,productEngraved:e.product_engraved,productEmbossed:e.product_embossed,productAdjustable:e.product_adjustable,productAdjusted:e.product_adjusted,personalizationType:e.product_personalizationType,mfPartNumber:e.product_mfPartNumber,defaultMfPartNumber:e.product_defaultMfPartNumber,productAvailability:e.product_is_in_stock,productCaseMaterial:e.product_casematerial,productJewelryMaterial:e.product_jewelmaterial,productStrapMaterial:e.product_strapmaterial,productLeatherMaterial:e.product_leathermaterial,productSize:e.product_size,productSkuMfPartNumber:e.product_skuMfPartNumber,dataSt:e.dataSt})}catch(r){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}",t,r.message),"error")}},trackTransactionInEuro:function(t,r){return!1},trackTransactionWithStandardCurrency:function(t,r){return!1},_trackTransaction:function(t){return!1},_setCustomDimensions:function(){return!1},parseDataLayer:function(){return!1},trackPageView:function(t){return!1},trackPromotionsImpressions:function(){window.tc_vars.promos={};var r={},e=[];t("[data-ytos-track-promotions-data]").each(function(r,o){var a=t(o).data("ytos-track-promotions-data"),i={promotion_id:a.promotion_id,promotion_name:a.promotion_name,promotion_creative:a.promotion_creative,promotion_position:a.position};e.push(i)}.bind(this)),r.promos=e,this.extendTcVars(r),$Y.notify("yTos::TagCommander::TcVarsPromosListUpdated")},trackPromotionsClick:function(t){var r=t.length>0?t[0]:t;if("function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,"enh_trackPromotionClicks",{promotion_id:r.id,promotion_name:r.name,promotion_creative:r.creative,promotion_position:r.position})}catch(t){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}","enh_trackPromotionClicks",t.message),"error")}},trackVirtualPageView:function(t){var r=t.length>0?t[0]:t;if(window.tc_vars&&r&&(window.tc_vars.nav_stepName=r.stepName),"function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,"virtualPageView",{stepName:r.stepName})}catch(t){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}","virtualPageView",t.message),"error")}}}),yTos.tracking.TagCommander}));