define(["ytos.domlib","ui.scrollToError","ui.recaptcha"],(function(t){"use strict";const a=864e5;return yTos.utils.namespace("yTos.helpers.UI.AjaxForm"),yTos.helpers.UI.AjaxForm=function(){const e=yTos.helpers.base.extend({name:"ui.ajaxForm",initialize:function(){},validationTemplate:'<div data-ytos-validation-msg="" class="field-validation-error"></div>',events:{"^ document form[data-ytos-ajax] submit":"submitTroughAjaxRecaptcha","^ document form[data-ytos-ajax] input[data-val] blur":"validateOnBlur","^ document form[data-ytos-ajax] textarea[data-val] blur":"validateOnBlur","^ document form[data-ytos-ajax] select[data-val] blur":"validateOnBlur","^ document form[data-ytos-ajax] [data-ytos-password-strength-validation] keyup":"passwordStrength","^ document form[data-ytos-ajax] textarea[data-ytos-char-count] keyup":"charCount"},globalMessages:{"yTos::AjaxForm::FormValidated":"onFormValidated"},onFormValidated:function(a){a.isFormValid||$Y.notify("yTos::AjaxForm::ScrollToErrorReady",t(a.form))},validationRules:[{name:"valRequired",validator:function(t,a){const e=t.val()||"";if(t.is(":checkbox")){if(t.is(":checked"))return""}else if(""!==e.toString()||a.valRequiredCondition&&0===t.closest("form").find(a.valRequiredCondition).length)return"";return t.data("valRequired")}},{name:"valEqualto",validator:function(t,a,e){const n=t.closest("form"),o='input[name="'+a.valEqualtoOther.replace("*.",e+".")+'"]',i=n.find(o);return"email"===t.attr("type")?t.val().toLowerCase()===i.val().toLowerCase()?"":t.data("valEqualto"):t.val()===i.val()?"":t.data("valEqualto")}},{name:"valNotequalto",validator:function(t,a,e){const n=t.closest("form"),o='input[name="'+a.valNotequaltoOther.replace("*.",e+".")+'"]',i=n.find(o);return t.val()!==i.val()?"":t.data("valNotequalto")}},{name:"valLengthMax",validator:function(t,a){return t.val().length<=a.valLengthMax?"":t.data("valLength")}},{name:"valLengthMin",validator:function(t,a){return t.val().length>=a.valLengthMin?"":t.data("valLength")}},{name:"valRegexPattern",validator:function(t,a){const e=a.valRegexPattern.replace("(?i)[^","^[");return(t.is("[data-val-regex-insensitive]")?new RegExp(e,"i"):new RegExp(e)).test(t.val())?"":t.data("valRegex")}},{name:"valOlderThan",validator:function(t){const a=t.val();if(!a)return"";const e=new Date,n=new Date(a);let o=e.getFullYear()-n.getFullYear();n>e.setFullYear(e.getFullYear()-o)&&o--;return o>=Number(t.data("val-older-than"))?"":t.data("val-older-than-message")}},{name:"valDateLessThanOrEqualTo",validator:function(t){const e=t.val();if(!e)return"";const n=new Date(t.data("val-date-less-than-or-equal-to"))-new Date(e);return Math.ceil(n/a)>=0?"":t.data("val-date-less-than-or-equal-to-message")}},{name:"valDateMoreThanOrEqualTo",validator:function(t){const e=t.val(),n=t.get(0).valueAsDate;if(!e)return"";const o=new Date(t.data("val-date-more-than-or-equal-to")),i=(n||yTos.helpers.UI.AjaxForm.parseDataInputValue(e))-o;return Math.ceil(i/a)>=0?"":t.data("val-date-more-than-or-equal-to-message")}},{name:"valRemoteUrl",validator:function(a,e){const n=e.valRemoteUrl,o=e.valRemoteAdditionalfields.replace(/\*/g,"").split(",");let i=null;const s={};for(let a=0;a<o.length;a++)i=t('*[name*="'+o[a]+'"]'),s[i.attr("name").replace(".","")]=i.val();return yTos.ajax(n+"?"+t.param(s),{async:!1}),""!==a.val().toString()?"":a.data("valRemote")}},{name:"creditCardChecksum",isMandatory:function(t){return t.data("checksum-mandatory")},validator:function(t){let a=t.val();if("string"==typeof a&&(a=$Y.trim(a)),0===a.length)return!1;a=a.replace(/\s/g,"");const e=a;let n,o=0,i=1;for(let t=e.length-1;t>=0;t--)n=Number(e.charAt(t))*i,n>9&&(o+=1,n-=10),o+=n,i=1===i?2:1;const s=o%10==0,r=!!t.data("checksum-mandatory"),l=s,d=t.data("creditCardChecksum");return s||r?s&&$Y.notify("yTos::AjaxForm::LuhnCheckSumInfoValidated"):$Y.notify("yTos::AjaxForm::LuhnCheckSumInfo",{message:d}),l?"":d}},{name:"valCustomRule",validator:function(t,a){return"false"===a.valCustomRuleChecksum||!1===a.valCustomRuleChecksum?a.valCustomRuleMessage:""}},{name:"customValidations",validator:function(t,a,e,n){const o=a.customValidationLabels||{},i=a.customValidations||[];for(const a of i){const e=n.find((t=>t.name===a));if(e&&"function"==typeof e.validator&&!e.validator(t)){return o[a]}}return""}.bind(this)},{name:"XssCheck",validator:function(t){const a=t.val();return!/[<>]/gi.test(a)}},{name:"LinkCheck",validator:function(t){const a=t.val();return!/(https?|ftps?|gopher|telnet|nntp):\/\/|(mailto|news):|www\./gi.test(a)}}],validateOnBlur:function(a){const e=t(a.currentTarget),n=this.getScope(e),o=this.validateInput(e);this.notifyResult(e,o,n)},notifyResult:function(t,a,e){$Y.notify("yTos::AjaxForm::InputValidated",{input:t,isValid:a}),$Y.notify("yTos::AjaxForm::AjaxFormInputValidated",{input:t,isValid:a},{scope:e})},passwordStrength:function(a){const e=t(a.currentTarget),n=e.parents("[data-ytos-password-container]").find("*[data-ytos-password-strength]"),o=e.val(),i=new RegExp("^[\\-a-z0-9\\'\\^&\\*\\(\\)\\/#!_@%\\.\\$\\|\\?=\\\\]{6,15}$","i");let s={strength:-1},r=-1;const l={weak:{strength:0,regex:"(?=.{6,}).*"},medium:{strength:1,regex:"^(?=.{6,})((?=.*[a-zA-Z])(?=.*[0-9])|(?=.*[a-zA-Z])(?=.*[\\W_])|(?=.*[0-9])(?=.*[\\W_])).*$"},strong:{strength:2,regex:"^(?=.{6,})((?=.*[a-zA-Z])(?=.*[\\W_])(?=.*[0-9])).*$"}};if(e.val().length<=6&&n.find("*[data-ytos-password-level]").removeClass("selected"),e.val().length>=6){for(const t in l)Object.prototype.hasOwnProperty.call(l,t)&&new RegExp(l[t].regex,"g").test(o)&&l[t].strength>s.strength&&(s=l[t],r=t);n.find("*[data-ytos-password-level]").removeClass("selected"),n.find("[data-ytos-password-level='"+r+"']").addClass("selected"),$Y.notify("yTos::AjaxForm::PasswordStrength",{level:r,strength:s.strength})}return i.test(o)},charCount:function(a){const e=t(a.currentTarget),n=e.data("val-length-max");if(void 0===n)return;const o=t("[data-ytos-char-count-wrapper]"),i=o.find("[data-ytos-char-count-msg]"),s=e.val();let r=n-s.length;r<=0?(o.addClass("charLimitReached"),r=0,e.val(s.substr(0,n))):o.removeClass("charLimitReached"),i.html(r),$Y.notify("yTos::AjaxForm::CharCount",{inputId:e.attr("id"),remainingChars:r})},validateInput:function(t){t.val(t.val().trim());const a=t.parents("*[data-ytos-input-container]"),e=t[0].name.split(".")[0],n=t.data();let o=!0;const i=void 0!==n.valRequired||""!==t.val();return a.find("*[data-ytos-validation-msg]").hide(),a.removeClass("invalidRow").addClass("validRow"),t.removeClass("invalid").addClass("valid"),i&&this.validationRules.every(function(i){return o=this._tryValidateInputField(i,n,e,t,a),o}.bind(this)),o},_tryValidateInputField:function(t,a,e,n,o){if(!!a[t.name]){const i=this._isMandatory(n,t),s=t.validator(n,a,e,this.validationRules),r=""===s;if(this._attachValidationClasses(n,o,r,i),this._tryAttachErrorMessage(o,t.name,s,r),!r&&("valRequired"===t.name||i))return!1}return!0},_isMandatory:function(t,a){return a&&"function"==typeof a.isMandatory?a.isMandatory(t):!t.is("[data-validation-mandatory]")||t.data("validation-mandatory")},_tryGetErrorContainer:function(a,e){let n=a.find('*[data-ytos-validatedrule="'+e+'"]');return 0===n.length&&(n=t(this.validationTemplate),n.attr("data-ytos-validatedrule",e),n.appendTo(a)),n.eq(0)},_tryAttachErrorMessage:function(t,a,e,n){const o=t.find("*[data-validation-container-for]"),i=this._tryGetErrorContainer(o,a);if(n)i.hide();else{const t=this._tryGetMessageContainer(i);t.html(e),o.html(i),i.show(),t.show()}},_tryGetMessageContainer:function(t){let a;return a=t[0]&&t[0].getAttribute("data-ytos-validation-msg")?t:t.find("*[data-ytos-validation-msg]").length>0?t.find("*[data-ytos-validation-msg]"):t.filter("*[data-ytos-validation-msg]"),a},_attachValidationClasses:function(t,a,e,n){t.removeClass("valid").removeClass("invalid").removeClass("warning"),a.removeClass("invalidRow").removeClass("validRow").removeClass("warningRow"),!e&&n?(t.addClass("invalid"),a.addClass("invalidRow")):e||n?(t.removeClass("invalid").addClass("valid"),a.removeClass("invalidRow").addClass("validRow")):(t.addClass("warning"),a.addClass("warningRow"))},resetInputValidation:function(t){const a=t.parents("[data-ytos-input-container]"),e=a.find("[data-validation-container-for]");a.removeClass("invalidRow validRow"),t.removeClass("invalid valid"),e.empty()},validateForm:function(a){let e=!0;return t(a).find("[data-val]").each(function(a,n){const o=t(n);let i=!0;(o.data("val")||""!==o.val())&&(i=this.validateInput(o)),e=e&&i}.bind(this)),$Y.notify("yTos::AjaxForm::FormValidated",{form:a,isFormValid:e}),e},isFormValid:function(a){return t(a).find("[data-val]").toArray().filter(this.inputShouldBeChecked).every(this.isInputValid.bind(this))},isInputValid:function(a){const e=t(a),n=e[0].name.split(".")[0],o=e.data();return this.validationRules.filter((function(t){return!!o[t.name]})).every(function(t){const a=this._isMandatory(e,t);return""===t.validator(e,o,n,this.validationRules)||"valRequired"!==t.name&&!a}.bind(this))},inputShouldBeChecked:function(a){const e=t(a);return void 0!==e.data("valRequired")||""!==e.val()},resetForm:function(a){const e=t(a),n=this.getScope(e);e.find("[data-ytos-input-container]").find("input, select, textarea").filter(":not([readonly])").each((function(a,e){const n=t(e),o=t(e)[0].type,i=t(e)[0].tagName;"checkbox"!==o&&"radio"!==o||"INPUT"!==i?"SELECT"===i?n.prop("selected",!1):("hidden"!==o&&"INPUT"===i||"TEXTAREA"===i)&&n.val(""):n.prop("checked",!1)})),$Y.notify("yTos::AjaxForm::FormReset",{form:e}),$Y.notify("yTos::AjaxForm::AjaxFormReset",{form:e},{scope:n})},submitTroughAjaxRecaptcha:function(a){a.preventDefault();const e=a.currentTarget,n=t(e).find("[data-ytos-recaptcha-opt]").data("ytosRecaptchaOpt");return n&&3===n.version?require([n.url],function(){window.grecaptcha.ready(function(){const a=t(e).attr("action").split("/").pop();window.grecaptcha.execute(yTos.configuration.Recaptchav3ClientId,{action:a}).then(function(a){t(e).find('input[name="g-recaptcha-response"]').remove(),t(e).append('<input type="hidden" name="g-recaptcha-response" value="'+a+'">'),this.submitTroughAjax(e)}.bind(this))}.bind(this))}.bind(this)):this.submitTroughAjax(e),!1},submitTroughAjax:function(a,e){const n=t(a),o=e||n.serializeArray(),i=n.data("ytos-ctrl")||n.closest("[data-ytos-ctrl]").data("ytos-ctrl"),s=this.getScope(n);if(this.validateForm(a)&&!n.data("ytos-pending")){$Y.notify("yTos::BeginAjaxRequest",{element:n}),$Y.notify("yTos::BeginAjaxFormRequest",{element:n},{scope:s});const e=$Y.getAbsoluteURL(n.attr("action"),$Y.isCORSSupported());return n.data("ytos-pending",!0),this._pendingPromise=yTos.ajax(e,{type:a.method,data:o,xhrFields:{withCredentials:!0},headers:{"X-Requested-With":"XMLHttpRequest"},success:function(a){const e=t(this);e.data("ytos-pending",!1);const n=e.data(),o=n.ytosFormSuccess;if(i&&"function"==typeof i[o])i[o](a);else if("string"==typeof o)if(n.ytosFormScope){const t=i.scope;$Y.notify(o,a,{scope:t})}else $Y.notify(o,a);else t(this).html($Y.trim(a));$Y.notify("yTos::EndAjaxRequest",{element:t(this)}),$Y.notify("yTos::EndAjaxFormRequest",{element:t(this)},{scope:s})}.bind(a),error:function(a,e,n,o){const i=t(this);i.data("ytos-pending",!1);const r=t($Y.trim(e.responseText)),l=i.data("ytos-form-error");let d=null;if(r.find("form").length>0){d=r.find("form").children(),i.html(d);const t=i.closest("[data-ytos-ctrl]");t.length>0&&(yTos.helpers.destroyPlugins(t,!0),yTos.helpers.initializeHelpers(t,{isAsyncronouslyLoaded:!0}))}else r.filter("form").length>0?(yTos.helpers.destroyPlugins(i,!1),d=r.children(),i.html(d),yTos.helpers.initializeHelpers(i,{isAsyncronouslyLoaded:!0})):d=r;403===e.status&&a&&"function"==typeof a.refreshOnAntiforgeryException&&a.refreshOnAntiforgeryException(),a&&"function"==typeof a[l]?a[l](d,e.status,o):l&&(t(this).data().ytosFormScope?$Y.notify(l,d,{scope:a.scope}):$Y.notify(l,d));const u=i.find("[data-ytos-validation-summary]");u.length&&$Y.focusElement(u.get(0)),$Y.notify("yTos::EndAjaxRequest",{element:i}),$Y.notify("yTos::EndAjaxFormRequest",{element:i},{scope:s})}.bind(a,i)}),this._pendingPromise}return n.data("ytos-pending")?this._pendingPromise:Promise.reject()},getScope:function(t){const a=t.yTos("scope")||t.parents("form[data-ytos-scope]").yTos("scope");return a||!!a},parseDataInputValue:function(t){const a=/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(t);return a&&a.length>0?new Date(t):0}});return $Y.notify("yTos::HelperParsed::ui.ajaxForm",e),new e}(),$Y.notify("yTos::HelperLoaded::ui.ajaxForm",yTos.helpers.UI.AjaxForm),yTos.helpers.UI.AjaxForm}));