define(["ytos.domlib","ytos.product","ui.selectAsList","ytos.share"],(function(e,t,o){"use strict";const s=window.requirejs("replaceColorMiddleware");return yTos.utils.namespace("yTos.helpers.Product.HTMLSelectColorSelector"),yTos.helpers.Product.HTMLSelectColorSelector=yTos.helpers.base.extend({initialize:function(){const e=this.model=yTos.models.ProductsCollection({scope:this.scope});this.share=yTos.models.ShareCollection({scope:this.scope}),e.watch("selectedSize",this.checkSelectedCombinationIsAvailable,this),e.watch("selectedProduct",(function(){this.updatesDropdown(e.get("selectedColor"))}),this),this.trySetSelectedColor(),this.storeCurrentColors()},events:{"select change":"selectColor"},globalMessages:{"yTos::Product::PrivateSalesAllowed":"refresh"},localMessages:{"yTos::Product::UpdateExchangeableColors":"setExchangeableColorsBySkuPartNumbers","yTos::Product::HTMLSelectColorSelectorUpdated":"storeCurrentColors"},requiredHelpers:{SelectAsList:o},trySetSelectedColor:function(){const e=this.$("[data-ytos-color-identifier].is-selected").yTos("color-identifier");this.model.extendDefaults({selectedColor:e}),this.model.get("selectedImageColor")||this.model.extendDefaults({selectedImageColor:e}),this.model.isProductAvailable(e,this.model.get("selectedSize")).then(function(e){this.model.set("isSelectedProductAvailable",e)}.bind(this)),e||this.notify("yTos::Product::SelectedColorNotAvailable",{partNumber:this.options.PartNumber})},isDOMUpdatedManually:function(){return 0===this.$el.closest('[data-ytos-ctrl="product.blockUpdater"]').length},refreshAfterInitialization:function(){if(!this.isDOMUpdatedManually())return;const e=this.options.PartNumber||this.model.get("landingColorPartNumber");this.refresh(e)},refresh:function(e){e||(e=this.options.PartNumber||this.model.get("landingColorPartNumber"));const t=$Y.pick(["JavaScriptHelperScope","ShouldRenderAvailabilityInfoOnMouseOver","ShouldRenderImageThumb","ShouldRenderOnlyBuyableColors","ThumbShot","TemplateUrlDetails","ShouldEnableShareUrl","ShouldInitShareUrl"],this.options);this.getHTML({Plugin:"Item",Action:"RenderHTMLSelectColorSelectorAsync"},{data:$Y.prepareData({partNumber:e,siteCode:this.options.SiteCode,options:t}),success:function(e){this.notify("yTos::Product::HTMLSelectColorSelectorUpdated",{$el:e},{scope:this.scope})}.bind(this),autoUpdate:!0,stripMe:!0})},checkSelectedCombinationIsAvailable:function(e){this.model.isProductAvailable(this.model.get("selectedColor"),e).then(this.updateModelState.bind(this))},updateModelState:function(e){this.model.set("isSelectedProductAvailable",e),this.model.set("selectedProduct",this.model.getSelectedProduct())},selectColor:function(t){const o=e(t.currentTarget).find("option:selected"),l=o.yTos("color-identifier"),i=o.yTos("color-model"),r=i&&i.ProductColorPartNumber;this.model.set("selectedColor",l),this.model.set("selectedImageColor",l),this.options.ShouldEnableShareUrl&&this.share.save("colorPartNumber",r,s),this.notify("yTos::Product::SelectedColorChanged",{color:o.yTos("colorModel")},{scope:this.scope}),this.notify("yTos::Tracking::SelectedColorChanged",{color:o.yTos("colorModel"),trackInfo:o.yTos("track")},{scope:this.scope})},setExchangeableColorsBySkuPartNumbers:function(e){if(!this.defaultColorsCache||!e||0===e.skuPartNumbersToInclude.length)return;const t=this.getColorsIdentifierBySkuPartNumbers(e.skuPartNumbersToInclude);Promise.all(t).then(function(e){const t=this.$("select");this.$("option").remove(),this.defaultColorsCache.each((function(o,s){""!==s.value?-1!==e.indexOf(s.value)&&t.append(s):t.append(s)}))}.bind(this))},getColorsIdentifierBySkuPartNumbers:function(e){return e.map(function(e){return this.model.getProductBySkuPartNumber(e).then((function(e){if(e.productColor&&e.productColor.identifier)return e.productColor.identifier}))}.bind(this))},storeCurrentColors:function(){this.defaultColorsCache=this.$("option")},updatesDropdown:function(e){this.updateSelectedOption(e),this.updateOptions(),this.storeCurrentColors()},updateSelectedOption:function(e){this.removeSelectedCssClass(),e?this.$('option[data-ytos-color-identifier="'+e+'"]').addClass("is-selected"):this.$("select").get(0).selectedIndex=0},updateOptions:function(){this.removeDisabledCssClass();const e=this.model.get("selectedSize");e&&this.$("option").each(this.updateOption.bind(this,e))},updateOption:function(t,o,s){const l=e(s),i=l.val();this.model.getProduct(i,t).then(function(e){l.toggleClass("is-disabled",this.shouldBeDisabled(e))}.bind(this))},shouldBeDisabled:function(e){return null==e||(e.soldOut||!e.buyable)},removeDisabledCssClass:function(){this.$("option").removeClass("is-disabled")},removeSelectedCssClass:function(){this.$("option").removeClass("is-selected")}}),yTos.helpers.Product.HTMLSelectColorSelector}));